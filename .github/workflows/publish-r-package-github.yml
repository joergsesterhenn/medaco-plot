name: Publish R Package to GitHub Packages

on:
  workflow_dispatch:  # Allows manual triggering from the GitHub UI

permissions:
  contents: write  # Allows pushing changes to the repository

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.1'  # Specify your desired R version

      - name: Install dependencies for renv
        run: |
          Rscript -e "install.packages('renv')"

      - name: Restore renv environment
        run: |
          Rscript -e "renv::restore()"

      - name: Ensure NEWS.md exists
        run: |
          if [ ! -f NEWS.md ]; then
            echo "Creating NEWS.md file."
            touch NEWS.md
            echo "# Changelog" > NEWS.md
          fi

      - name: Collect commit messages for changelog
        id: changelog
        run: |
          # Check if any previous tags exist
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            latest_tag=$(git describe --tags --abbrev=0)
            commit_messages=$(git log $latest_tag..HEAD --pretty=format:"- %s")
          else
            commit_messages=$(git log --pretty=format:"- %s")
          fi

          # Save commit messages to a GitHub Actions output, only if they exist
          if [ -n "$commit_messages" ]; then
            echo "::set-output name=messages::$commit_messages"
          else
            echo "No new commit messages to include."
          fi

      - name: Read package version
        id: get_version
        run: |
          version=$(grep '^Version:' DESCRIPTION | awk '{print $2}')
          echo "Package version is $version"
          echo "::set-output name=version::$version"

      - name: Update NEWS.md
        if: steps.changelog.outputs.messages  # Only run if there are new messages
        run: |
          # Append new section to NEWS.md with version and date
          echo -e "\n## $(date +'%Y-%m-%d') - v${{ steps.get_version.outputs.version }}\n" >> NEWS.md
          echo "${{ steps.changelog.outputs.messages }}" >> NEWS.md
          
          # Check if NEWS.md changed before committing
          if [ -n "$(git status --porcelain NEWS.md)" ]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add NEWS.md
            git commit -m "Update NEWS.md for release ${{ steps.get_version.outputs.version }}"
            git push
          else
            echo "No changes to NEWS.md, skipping commit."
          fi

      - name: Tag the release
        id: tag_release
        run: |
          # Get the version from the previous step
          version="${{ steps.get_version.outputs.version }}"
          # Create the tag
          git tag "v$version"
          git push origin "v$version"  # Push the tag to the repository


      - name: Build and check package
        run: |
          Rscript -e "devtools::install_deps(dependencies = TRUE)"
          R CMD build .
          R CMD check *.tar.gz

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the GitHub release
          gh release create "v${{ steps.get_version.outputs.version }}" --title "Release v${{ steps.get_version.outputs.version }}" *.tar.gz
